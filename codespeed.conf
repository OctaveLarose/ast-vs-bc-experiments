# -*- mode: yaml -*-
# Config file for ReBench
default_experiment: all
default_data_file: 'benchmark.data'

.are_we_fast_yet:
    ## this is ignored by rebench
    iteration_numbers:
        fast_vm:      &FAST_VM      1000
        slow_vm:      &SLOW_VM      250
        slower_vm:    &SLOWER_VM    85
        very_slow_vm: &VERY_SLOW_VM 15

runs:
  max_invocation_time: 3600

reporting:
    rebenchdb:
        # this url needs to point to the API endpoint
        db_url: https://rebench.stefan-marr.de/rebenchdb
        repo_url: https://github.com/smarr/awfy-runs
        record_all: true # make sure everything is recorded
        project_name: Are We Fast Yet

# definition of benchmark suites
benchmark_suites:
    som-steady:
        gauge_adapter: RebenchLog
        command: " -cp .:Core:CD:DeltaBlue:Havlak:Json:NBody:Richards:/home/gitlab-runner/.local/TruffleSOM/Smalltalk Harness.som  %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        location: awfy/benchmarks/SOM
        benchmarks: &BENCHMARKS
            - DeltaBlue:
                extra_args: 12000
                codespeed_name: "[peak] DeltaBlue"
            - Richards:
                extra_args: 100
                codespeed_name: "[peak] Richards"
            - Json:
                extra_args: 100
                codespeed_name: "[peak] Json"
            - CD:
                extra_args: 250
                codespeed_name: "[peak] CD"
            - Havlak:
                extra_args: 1500
                codespeed_name: "[peak] Havlak"

            - Bounce:
                extra_args: 1500
                codespeed_name: "[peak] Bounce"
            - List:
                extra_args: 1500
                codespeed_name: "[peak] List"
            - Mandelbrot:
                extra_args: 500
                codespeed_name: "[peak] Mandelbrot"
            - NBody:
                extra_args: 250000
                codespeed_name: "[peak] NBody"
            - Permute:
                extra_args: 1000
                codespeed_name: "[peak] Permute"
            - Queens:
                extra_args: 1000
                codespeed_name: "[peak] Queens"
            - Sieve:
                extra_args: 3000
                codespeed_name: "[peak] Sieve"
            - Storage:
                extra_args: 1000
                codespeed_name: "[peak] Storage"
            - Towers:
                extra_args: 600
                codespeed_name: "[peak] Towers"

    som-interp:
        gauge_adapter: RebenchLog
        command: " -cp .:Core:CD:DeltaBlue:Havlak:Json:NBody:Richards:/home/gitlab-runner/.local/TruffleSOM/Smalltalk Harness.som  %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        location: awfy/benchmarks/SOM
        benchmarks: *BENCHMARKS

    csom-interp:
        gauge_adapter: RebenchLog
        command: " -cp .:Core:CD:DeltaBlue:Havlak:Json:NBody:Richards:/home/gitlab-runner/.local/CSOM/Smalltalk Harness  %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        location: awfy/benchmarks/SOM
        benchmarks: *BENCHMARKS

    java-steady:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Java
        command: " -cp benchmarks17.jar Harness %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        benchmarks: *BENCHMARKS
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            ant clean; ant jar
            mv benchmarks.jar benchmarks17.jar

    java-interp:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Java
        command: " -cp benchmarks17.jar Harness %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        benchmarks: *BENCHMARKS
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            ant clean; ant jar
            mv benchmarks.jar benchmarks17.jar

    java8-steady:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Java
        command: " -cp benchmarks8.jar Harness %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        benchmarks: *BENCHMARKS
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
            ant clean; ant jar
            mv benchmarks.jar benchmarks8.jar

    java8-interp:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Java
        command: " -cp benchmarks8.jar Harness %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        benchmarks: *BENCHMARKS
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
            ant clean; ant jar
            mv benchmarks.jar benchmarks8.jar

    java-native:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Java
        command: " %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        benchmarks: *BENCHMARKS
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            ant clean; ant jar
            /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin/native-image -cp benchmarks.jar Harness benchmarks

    ruby-jit:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Ruby
        command: "harness.rb %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        benchmarks: *BENCHMARKS

    ruby-interp:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Ruby
        command: "harness.rb %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        benchmarks: *BENCHMARKS

    js-jit:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/JavaScript
        command: "harness.js %(benchmark)s %(iterations)s "
        iterations: *FAST_VM
        benchmarks: *BENCHMARKS

    js-interp:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/JavaScript
        command: "harness.js %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM
        benchmarks: *BENCHMARKS

    python-interp:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Python
        command: "harness.py %(benchmark)s %(iterations)s "
        iterations: *VERY_SLOW_VM ## the number iterations measured
        benchmarks: *BENCHMARKS

    python-jit:
        gauge_adapter: RebenchLog
        location: awfy/benchmarks/Python
        command: "harness.py %(benchmark)s %(iterations)s "
        iterations: *FAST_VM ## the number iterations measured
        benchmarks: *BENCHMARKS



executors:
    Java-native:
        path: awfy/benchmarks/Java
        executable: benchmarks

    Java-int:
        path: /usr/lib/jvm/java-17-openjdk-amd64/bin/
        executable: java
        args: -Xint
    Java-C2-jit:
        path: /usr/lib/jvm/java-17-openjdk-amd64/bin/
        executable: java
    Java8-int:
        path: /usr/lib/jvm/java-8-openjdk-amd64/bin/
        executable: java
        args: -Xint
    Java8-C2-jit:
        path: /usr/lib/jvm/java-8-openjdk-amd64/bin/
        executable: java

    CSOM-int:
        path: /home/gitlab-runner/.local
        executable: CSOM/CSOM
        build:
          - |
            scripts/load_git_repo https://github.com/SOM-st/CSOM CSOM master
            cd CSOM
            make

    TruffleSOM-ast-HotspotCE-jit-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som
        args: -Dsom.interp=AST
    TruffleSOM-ast-HotspotEE-jit-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som
        args: -Dsom.interp=AST -EG /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            SHA=c0ca77fed790812838ba35bf29eac9b2f2349a05
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            ant compile
    TruffleSOM-bc-HotspotCE-jit-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som
        args: -Dsom.interp=BC
    TruffleSOM-bc-HotspotEE-jit-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som
        args: -Dsom.interp=BC -EG /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0

    TruffleSOM-ast-NativeEE-int-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som-native-interp-ast-ee
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            export GRAALEE_HOME=/home/gitlab-runner/.local/graalvm-ee-java17-22.3.0
            SHA=c0ca77fed790812838ba35bf29eac9b2f2349a05
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            ant compile native-ast-ee -Dno.jit=true
    TruffleSOM-bc-NativeEE-int-main:
        path: /home/gitlab-runner/.local/TruffleSOM
        executable: som-native-interp-bc-ee
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            export GRAALEE_HOME=/home/gitlab-runner/.local/graalvm-ee-java17-22.3.0
            SHA=c0ca77fed790812838ba35bf29eac9b2f2349a05
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            ant compile native-bc-ee -Dno.jit=true

    TruffleSOM-ast-NativeEE-int-uber:
        path: /home/gitlab-runner/.local/TruffleSOM-uber
        executable: som-native-interp-ast-ee
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            export GRAALEE_HOME=/home/gitlab-runner/.local/graalvm-ee-java17-22.3.0
            SHA=5f30f52b52a767a646da5c0264ee9128288ba0e0
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            ant compile native-ast-ee -Dno.jit=true
    TruffleSOM-ast-NativeEE-int-super:
        path: /home/gitlab-runner/.local/TruffleSOM-super
        executable: som-native-interp-ast-ee
        build:
          - |
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
            export GRAALEE_HOME=/home/gitlab-runner/.local/graalvm-ee-java17-22.3.0
            SHA=273bc9f3736e4bb3aff97f2c91e882cd1f2565c9
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            ant compile native-ast-ee -Dno.jit=true

    PySOM-ast-jit:
        path: /home/gitlab-runner/.local/PySOM
        executable: som-ast-jit
        build:
          - |
            SHA=65ef72f44252439b724a7429408dac7f8d1b1d98
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            SOM_INTERP=AST /home/gitlab-runner/.local/pypy2.7-v7.3.9-src/rpython/bin/rpython -Ojit src/main_rpython.py
    PySOM-ast-int:
        path: /home/gitlab-runner/.local/PySOM
        executable: som-ast-interp
        build:
          - |
            SHA=65ef72f44252439b724a7429408dac7f8d1b1d98
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            SOM_INTERP=AST /home/gitlab-runner/.local/pypy2.7-v7.3.9-src/rpython/bin/rpython src/main_rpython.py
    PySOM-bc-jit:
        path: /home/gitlab-runner/.local/PySOM
        executable: som-bc-jit
        build:
          - |
            SHA=65ef72f44252439b724a7429408dac7f8d1b1d98
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            SOM_INTERP=BC /home/gitlab-runner/.local/pypy2.7-v7.3.9-src/rpython/bin/rpython -Ojit src/main_rpython.py
    PySOM-bc-int:
        path: /home/gitlab-runner/.local/PySOM
        executable: som-bc-interp
        build:
          - |
            SHA=65ef72f44252439b724a7429408dac7f8d1b1d98
            git fetch --all && git checkout -f $SHA && git submodule update -f --init --recursive
            SOM_INTERP=BC /home/gitlab-runner/.local/pypy2.7-v7.3.9-src/rpython/bin/rpython src/main_rpython.py

    CRuby-int:
        path: /home/gitlab-runner/.local/ruby-3.1.0
        executable: ruby

    CRuby-y-jit:
        path: /home/gitlab-runner/.local/ruby-3.1.0
        executable: ruby
        args: --yjit

    TruffleRuby-HotspotEE-jit:
        path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
        executable: truffleruby
        args: --jvm

    TruffleRuby-NativeEE-int:
        path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
        executable: truffleruby
        args: --native --experimental-options --engine.Compilation=false


    # JavaScript VMs
    Node-jit:
        executable: node
    Node-int:
        executable: node
        args: --jitless
    GraalJS-HotspotEE-jit:
        path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
        executable: node
        args: --jvm
    GraalJS-NativeEE-int:
        path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
        executable: node
        args: --native --experimental-options --engine.Compilation=false

    CPython-int:
      executable: python3.11
    PyPy-jit:
      path: /home/gitlab-runner/.local/pypy3.8-v7.3.9-linux64/bin
      executable: pypy3
    PyPy-int:
      path: /home/gitlab-runner/.local/pypy3.8-v7.3.9-linux64/bin
      executable: pypy3
      args: --jit off
    GraalPython-HotspotEE-jit:
      path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
      executable: graalpy
      args: --jvm --vm.Xss5m
    GraalPython-NativeEE-int:
      path: /home/gitlab-runner/.local/graalvm-ee-java17-22.3.0/bin
      executable: graalpy
      args: --native --experimental-options --engine.Compilation=false


experiments:
    java:
        executions:
            - Java-native:
                 suites: [java-native]

            - Java-C2-jit:
                 suites: [java-steady]
            - Java-int:
                 suites: [java-interp]
            - Java8-C2-jit:
                 suites: [java8-steady]
            - Java8-int:
                 suites: [java8-interp]

    som:
        executions:
            - CSOM-int:
                suites: [csom-interp]
            - TruffleSOM-ast-HotspotCE-jit-main:
                suites: [som-steady]
            - TruffleSOM-bc-HotspotCE-jit-main:
                suites: [som-steady]
            - TruffleSOM-ast-HotspotEE-jit-main:
                suites: [som-steady]
            - TruffleSOM-bc-HotspotEE-jit-main:
                suites: [som-steady]
            - TruffleSOM-ast-NativeEE-int-main:
                suites: [som-interp]
            - TruffleSOM-bc-NativeEE-int-main:
                suites: [som-interp]
            - TruffleSOM-ast-NativeEE-int-uber:
                suites: [som-interp]
            - TruffleSOM-ast-NativeEE-int-super:
                suites: [som-interp]

            - PySOM-ast-jit:
                suites: [som-steady]
            - PySOM-ast-int:
                suites: [som-interp]
            - PySOM-bc-jit:
                suites: [som-steady]
            - PySOM-bc-int:
                suites: [som-interp]

    js:
        executions:
            - Node-jit:
                suites: [js-jit]
            - Node-int:
                suites: [js-interp]
            - GraalJS-HotspotEE-jit:
                suites: [js-jit]
            - GraalJS-NativeEE-int:
                suites: [js-interp]

    ruby:
        executions:
            - CRuby-int:
                suites: [ruby-interp]
            - CRuby-y-jit:
                suites: [ruby-interp]
            - TruffleRuby-HotspotEE-jit:
                suites: [ruby-jit]
            - TruffleRuby-NativeEE-int:
                suites: [ruby-interp]

    python:
      executions:
         - CPython-int:
             suites: [python-interp]
         - PyPy-int:
             suites: [python-interp]
         - PyPy-jit:
             suites: [python-jit]
         - GraalPython-HotspotEE-jit:
             suites: [python-jit]
         - GraalPython-NativeEE-int:
             suites: [python-interp]
